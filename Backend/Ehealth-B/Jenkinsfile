pipeline {
    agent any
    tools {
        maven "MAVEN"
    }
    environment {
        ARTIFACT_NAME = 'Ehealth-B-0.0.1-SNAPSHOT.jar'
        ARTIFACT_PATH = 'Backend/Ehealth-B/target'
    }
    stages {
        stage('Build') {
            steps {
                echo 'Build Start'
                checkout scmGit(branches: [[name: '*/ciPipeline']], 
                    extensions: [], 
                    userRemoteConfigs: [[credentialsId: 'd160d1c6-6304-4ba3-b050-7d418e127b85', 
                    url: 'https://github.com/E-Health-Organization/E-health-Backend.git']])
                sh 'cd Backend/Ehealth-B && mvn -B -DskipTests clean package'
                echo 'Build Finished'
            }
        }

        stage('Copy Artifact to Another Repo') {
            steps {
                script {
                    echo 'Cleaning previous target-repo if exists....'
                    sh 'rm -rf target-repo'

                    echo 'Cloning the target repository...'
                    sh 'git clone https://github.com/E-Health-Organization/Artifact_Ehealth_Backend.git target-repo'

                    echo 'Copying artifact...'
                    sh '''
                    cp ${ARTIFACT_PATH}/${ARTIFACT_NAME} target-repo/
                    cd target-repo
                    git config user.email "aymar.hakizimana@gmail.com"
                    git config user.name "HaAymar"
                    git add ${ARTIFACT_NAME}
                    git commit -m "Adding new build artifact"
                    git push https://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@github.com/E-Health-Organization/Artifact_Ehealth_Backend.git
                    '''

                    

                    echo 'Artifact copied successfully!'
                }
            }
        }
    }
}
